#!/usr/bin/env python3
# MalwareAnalyzer.py - 专门用于恶意软件分析的工具
# 功能：特征识别、行为分析、恶意软件分类、签名生成

import os
import json
import hashlib
import re
from datetime import datetime
from java.awt import BorderLayout, GridLayout, FlowLayout, Color
from java.awt.event import ActionListener, ItemListener
from javax.swing import (
    JFrame, JPanel, JTabbedPane, JTextArea, JScrollPane, JButton, 
    JCheckBox, JLabel, JComboBox, JTextField, JOptionPane, JTable, 
    DefaultTableModel, JFileChooser, JProgressBar, JMenuBar, JMenu, JMenuItem,
    BoxLayout, BorderFactory, JTree, DefaultMutableTreeNode
)
from ghidra.app.script import GhidraScript
from ghidra.program.model.listing import Function, Instruction
from ghidra.program.model.symbol import Symbol, RefType
from ghidra.program.model.address import AddressSet
from ghidra.program.model.mem import MemoryAccessException
from ghidra.util.exception import CancelledException

class MalwareAnalyzer(GhidraScript):
    def __init__(self):
        self.program = None
        self.analysis_results = {}
        self.malware_signatures = {}
        self.behavior_patterns = {}
        self.yara_rules = []
        
    def run(self):
        """运行恶意软件分析器"""
        self.program = self.getCurrentProgram()
        if not self.program:
            self.println("没有打开的程序")
            return
        
        self.show_malware_analyzer()
    
    def show_malware_analyzer(self):
        """显示恶意软件分析器界面"""
        frame = JFrame("Malware Analyzer - 恶意软件分析工具")
        frame.setSize(1000, 700)
        frame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE)
        frame.setLocationRelativeTo(None)
        
        # 创建主面板
        main_panel = JPanel()
        main_panel.setLayout(BorderLayout())
        
        # 创建标签页
        tabbed_pane = JTabbedPane()
        
        # 特征识别标签
        signature_panel = self.create_signature_panel()
        tabbed_pane.addTab("特征识别", signature_panel)
        
        # 行为分析标签
        behavior_panel = self.create_behavior_panel()
        tabbed_pane.addTab("行为分析", behavior_panel)
        
        # 恶意软件分类标签
        classification_panel = self.create_classification_panel()
        tabbed_pane.addTab("恶意软件分类", classification_panel)
        
        # 签名生成标签
        signature_gen_panel = self.create_signature_gen_panel()
        tabbed_pane.addTab("签名生成", signature_gen_panel)
        
        # 报告生成标签
        report_panel = self.create_report_panel()
        tabbed_pane.addTab("报告生成", report_panel)
        
        main_panel.add(tabbed_pane, BorderLayout.CENTER)
        
        # 创建底部按钮面板
        button_panel = JPanel()
        button_panel.setLayout(FlowLayout(FlowLayout.RIGHT))
        
        analyze_button = JButton("开始分析")
        analyze_button.addActionListener(self.AnalyzeButtonListener(frame))
        
        cancel_button = JButton("取消")
        cancel_button.addActionListener(lambda e: frame.dispose())
        
        button_panel.add(analyze_button)
        button_panel.add(cancel_button)
        
        main_panel.add(button_panel, BorderLayout.SOUTH)
        
        frame.add(main_panel)
        frame.setVisible(True)
    
    def create_signature_panel(self):
        """创建特征识别面板"""
        panel = JPanel()
        panel.setLayout(BorderLayout())
        
        # 创建特征扫描选项面板
        scan_options_panel = JPanel()
        scan_options_panel.setLayout(BoxLayout(scan_options_panel, BoxLayout.Y_AXIS))
        scan_options_panel.setBorder(BorderFactory.createTitledBorder("特征扫描选项"))
        
        # 特征类型选项
        signature_types = JPanel()
        signature_types.setLayout(FlowLayout(FlowLayout.LEFT))
        
        sig_types = ["字符串特征", "导入函数特征", "节表特征", "PE头特征", "YARA规则"]
        sig_combo = JComboBox(sig_types)
        
        signature_types.add(JLabel("特征类型："))
        signature_types.add(sig_combo)
        
        scan_options_panel.add(signature_types)
        
        # YARA规则文件选项
        yara_panel = JPanel()
        yara_panel.setLayout(FlowLayout(FlowLayout.LEFT))
        
        yara_field = JTextField(40)
        browse_button = JButton("浏览...")
        
        yara_panel.add(JLabel("YARA规则文件："))
        yara_panel.add(yara_field)
        yara_panel.add(browse_button)
        
        scan_options_panel.add(yara_panel)
        
        # 自定义特征选项
        custom_sig_panel = JPanel()
        custom_sig_panel.setLayout(BoxLayout(custom_sig_panel, BoxLayout.Y_AXIS))
        custom_sig_panel.setBorder(BorderFactory.createTitledBorder("自定义特征"))
        
        custom_sig_text = JTextArea(10, 50)
        custom_sig_text.setLineWrap(True)
        custom_sig_text.setWrapStyleWord(True)
        custom_sig_text.setText("# 自定义特征规则\n# 格式：特征名=正则表达式\n# 例如：url_pattern=https?:\/\/[\w\-]+(\.[\w\-]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?")
        
        custom_sig_panel.add(JScrollPane(custom_sig_text))
        
        # 创建特征结果面板
        results_panel = JPanel()
        results_panel.setLayout(BorderLayout())
        results_panel.setBorder(BorderFactory.createTitledBorder("特征识别结果"))
        
        # 特征结果表格
        columns = ["特征名称", "类型", "位置", "匹配内容", "置信度"]
        self.signature_table_model = DefaultTableModel(columns, 0)
        signature_table = JTable(self.signature_table_model)
        
        results_panel.add(JScrollPane(signature_table), BorderLayout.CENTER)
        
        # 添加所有面板到特征识别面板
        content_panel = JPanel()
        content_panel.setLayout(BorderLayout())
        content_panel.add(scan_options_panel, BorderLayout.NORTH)
        content_panel.add(custom_sig_panel, BorderLayout.CENTER)
        content_panel.add(results_panel, BorderLayout.SOUTH)
        
        panel.add(content_panel, BorderLayout.CENTER)
        
        return panel
    
    def create_behavior_panel(self):
        """创建行为分析面板"""
        panel = JPanel()
        panel.setLayout(BorderLayout())
        
        # 创建行为分析选项面板
        behavior_options_panel = JPanel()
        behavior_options_panel.setLayout(BoxLayout(behavior_options_panel, BoxLayout.Y_AXIS))
        behavior_options_panel.setBorder(BorderFactory.createTitledBorder("行为分析选项"))
        
        # 行为类型选项
        behavior_types = JPanel()
        behavior_types.setLayout(FlowLayout(FlowLayout.LEFT))
        
        behavior_checkboxes = {
            "网络行为": JCheckBox("网络行为"),
            "文件操作": JCheckBox("文件操作"),
            "注册表操作": JCheckBox("注册表操作"),
            "进程操作": JCheckBox("进程操作"),
            "内存操作": JCheckBox("内存操作"),
            "系统调用": JCheckBox("系统调用")
        }
        
        for name, checkbox in behavior_checkboxes.items():
            checkbox.setSelected(True)
            behavior_types.add(checkbox)
        
        behavior_options_panel.add(behavior_types)
        
        # 分析深度选项
        depth_panel = JPanel()
        depth_panel.setLayout(FlowLayout(FlowLayout.LEFT))
        
        depth_combo = JComboBox(["快速分析", "标准分析", "深度分析"])
        depth_panel.add(JLabel("分析深度："))
        depth_panel.add(depth_combo)
        
        behavior_options_panel.add(depth_panel)
        
        # 创建行为分析结果面板
        results_panel = JPanel()
        results_panel.setLayout(BorderLayout())
        results_panel.setBorder(BorderFactory.createTitledBorder("行为分析结果"))
        
        # 行为树
        root_node = DefaultMutableTreeNode("行为分析结果")
        self.behavior_tree = JTree(root_node)
        
        results_panel.add(JScrollPane(self.behavior_tree), BorderLayout.CENTER)
        
        # 添加所有面板到行为分析面板
        content_panel = JPanel()
        content_panel.setLayout(BorderLayout())
        content_panel.add(behavior_options_panel, BorderLayout.NORTH)
        content_panel.add(results_panel, BorderLayout.CENTER)
        
        panel.add(content_panel, BorderLayout.CENTER)
        
        return panel
    
    def create_classification_panel(self):
        """创建恶意软件分类面板"""
        panel = JPanel()
        panel.setLayout(BorderLayout())
        
        # 创建分类结果面板
        classification_panel = JPanel()
        classification_panel.setLayout(BoxLayout(classification_panel, BoxLayout.Y_AXIS))
        classification_panel.setBorder(BorderFactory.createTitledBorder("恶意软件分类结果"))
        
        # 分类结果
        self.classification_text = JTextArea()
        self.classification_text.setEditable(False)
        self.classification_text.setLineWrap(True)
        self.classification_text.setWrapStyleWord(True)
        self.classification_text.setText("# 分类结果\n\n分析完成后将显示分类结果...")
        
        classification_panel.add(JScrollPane(self.classification_text))
        
        # 创建相似样本面板
        similar_panel = JPanel()
        similar_panel.setLayout(BorderLayout())
        similar_panel.setBorder(BorderFactory.createTitledBorder("相似样本"))
        
        # 相似样本表格
        columns = ["样本名称", "类型", "相似度", "来源", "最后分析时间"]
        self.similar_table_model = DefaultTableModel(columns, 0)
        similar_table = JTable(self.similar_table_model)
        
        similar_panel.add(JScrollPane(similar_table), BorderLayout.CENTER)
        
        # 添加所有面板到分类面板
        content_panel = JPanel()
        content_panel.setLayout(BorderLayout())
        content_panel.add(classification_panel, BorderLayout.NORTH)
        content_panel.add(similar_panel, BorderLayout.CENTER)
        
        panel.add(content_panel, BorderLayout.CENTER)
        
        return panel
    
    def create_signature_gen_panel(self):
        """创建签名生成面板"""
        panel = JPanel()
        panel.setLayout(BorderLayout())
        
        # 创建签名生成选项面板
        gen_options_panel = JPanel()
        gen_options_panel.setLayout(BoxLayout(gen_options_panel, BoxLayout.Y_AXIS))
        gen_options_panel.setBorder(BorderFactory.createTitledBorder("签名生成选项"))
        
        # 签名类型选项
        sig_gen_types = JPanel()
        sig_gen_types.setLayout(FlowLayout(FlowLayout.LEFT))
        
        gen_types = ["YARA规则", "哈希值", "特征字符串", "导入表特征"]
        gen_combo = JComboBox(gen_types)
        
        sig_gen_types.add(JLabel("签名类型："))
        sig_gen_types.add(gen_combo)
        
        gen_options_panel.add(sig_gen_types)
        
        # 签名参数选项
        params_panel = JPanel()
        params_panel.setLayout(GridLayout(3, 2, 10, 10))
        
        family_field = JTextField("未知家族")
        author_field = JTextField("Ghidra Malware Analyzer")
        description_field = JTextField("自动生成的恶意软件签名")
        
        params_panel.add(JLabel("恶意软件家族："))
        params_panel.add(family_field)
        params_panel.add(JLabel("作者："))
        params_panel.add(author_field)
        params_panel.add(JLabel("描述："))
        params_panel.add(description_field)
        
        gen_options_panel.add(params_panel)
        
        # 创建签名预览面板
        preview_panel = JPanel()
        preview_panel.setLayout(BorderLayout())
        preview_panel.setBorder(BorderFactory.createTitledBorder("签名预览"))
        
        self.signature_preview = JTextArea(20, 50)
        self.signature_preview.setEditable(False)
        self.signature_preview.setLineWrap(True)
        self.signature_preview.setWrapStyleWord(True)
        self.signature_preview.setText("# 签名预览\n\n生成签名后将显示在这里...")
        
        preview_panel.add(JScrollPane(self.signature_preview), BorderLayout.CENTER)
        
        # 创建导出按钮面板
        export_panel = JPanel()
        export_panel.setLayout(FlowLayout(FlowLayout.RIGHT))
        
        export_button = JButton("导出签名")
        export_panel.add(export_button)
        
        # 添加所有面板到签名生成面板
        content_panel = JPanel()
        content_panel.setLayout(BorderLayout())
        content_panel.add(gen_options_panel, BorderLayout.NORTH)
        content_panel.add(preview_panel, BorderLayout.CENTER)
        content_panel.add(export_panel, BorderLayout.SOUTH)
        
        panel.add(content_panel, BorderLayout.CENTER)
        
        return panel
    
    def create_report_panel(self):
        """创建报告生成面板"""
        panel = JPanel()
        panel.setLayout(BorderLayout())
        
        # 创建报告选项面板
        report_options_panel = JPanel()
        report_options_panel.setLayout(BoxLayout(report_options_panel, BoxLayout.Y_AXIS))
        report_options_panel.setBorder(BorderFactory.createTitledBorder("报告选项"))
        
        # 报告格式选项
        format_panel = JPanel()
        format_panel.setLayout(FlowLayout(FlowLayout.LEFT))
        
        formats = ["HTML", "PDF", "文本", "JSON"]
        format_combo = JComboBox(formats)
        
        format_panel.add(JLabel("报告格式："))
        format_panel.add(format_combo)
        
        report_options_panel.add(format_panel)
        
        # 报告内容选项
        content_panel = JPanel()
        content_panel.setLayout(BoxLayout(content_panel, BoxLayout.Y_AXIS))
        content_panel.setBorder(BorderFactory.createTitledBorder("报告内容"))
        
        content_options = ["基本信息", "特征分析", "行为分析", "分类结果", "签名信息", "修复建议"]
        for option in content_options:
            checkbox = JCheckBox(option)
            checkbox.setSelected(True)
            content_panel.add(checkbox)
        
        report_options_panel.add(content_panel)
        
        # 创建报告预览面板
        preview_panel = JPanel()
        preview_panel.setLayout(BorderLayout())
        preview_panel.setBorder(BorderFactory.createTitledBorder("报告预览"))
        
        self.report_preview = JTextArea(20, 50)
        self.report_preview.setEditable(False)
        self.report_preview.setLineWrap(True)
        self.report_preview.setWrapStyleWord(True)
        self.report_preview.setText("# 报告预览\n\n生成报告后将显示在这里...")
        
        preview_panel.add(JScrollPane(self.report_preview), BorderLayout.CENTER)
        
        # 创建生成按钮面板
        generate_panel = JPanel()
        generate_panel.setLayout(FlowLayout(FlowLayout.RIGHT))
        
        generate_button = JButton("生成报告")
        generate_panel.add(generate_button)
        
        # 添加所有面板到报告生成面板
        content_main = JPanel()
        content_main.setLayout(BorderLayout())
        content_main.add(report_options_panel, BorderLayout.NORTH)
        content_main.add(preview_panel, BorderLayout.CENTER)
        content_main.add(generate_panel, BorderLayout.SOUTH)
        
        panel.add(content_main, BorderLayout.CENTER)
        
        return panel
    
    def analyze_malware(self):
        """执行恶意软件分析"""
        # 初始化分析结果
        self.analysis_results = {
            'signatures': [],
            'behaviors': [],
            'classification': {},
            'similar_samples': []
        }
        
        # 执行特征识别
        self.identify_signatures()
        
        # 执行行为分析
        self.analyze_behaviors()
        
        # 执行恶意软件分类
        self.classify_malware()
        
        # 查找相似样本
        self.find_similar_samples()
        
        return self.analysis_results
    
    def identify_signatures(self):
        """识别恶意软件特征"""
        # 实际实现中，这里应该：
        # 1. 扫描字符串特征
        # 2. 分析导入函数
        # 3. 检查节表特征
        # 4. 分析PE头特征
        # 5. 应用YARA规则
        # 6. 检查自定义特征
        
        # 示例：添加一些模拟的特征识别结果
        sample_signatures = [
            {"name": "url_pattern", "type": "字符串特征", "location": "0x10005000", "content": "https://malicious-domain.com", "confidence": "高"},
            {"name": "encrypt_function", "type": "导入函数特征", "location": "0x10001000", "content": "CryptEncrypt", "confidence": "中"},
            {"name": "suspicious_section", "type": "节表特征", "location": ".data", "content": "可疑的节表名称", "confidence": "中"},
            {"name": "packed_executable", "type": "PE头特征", "location": "0x10000000", "content": "可能被加壳", "confidence": "高"}
        ]
        
        self.analysis_results['signatures'] = sample_signatures
    
    def analyze_behaviors(self):
        """分析恶意软件行为"""
        # 实际实现中，这里应该：
        # 1. 分析网络行为
        # 2. 分析文件操作
        # 3. 分析注册表操作
        # 4. 分析进程操作
        # 5. 分析内存操作
        # 6. 分析系统调用
        
        # 示例：添加一些模拟的行为分析结果
        sample_behaviors = [
            {"type": "网络行为", "action": "建立网络连接", "target": "malicious-domain.com:8080", "description": "尝试连接可疑域名"},
            {"type": "文件操作", "action": "写入文件", "target": "%APPDATA%\\malware.exe", "description": "在应用数据目录写入可执行文件"},
            {"type": "注册表操作", "action": "创建自启动项", "target": "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run", "description": "添加自启动注册表项"},
            {"type": "进程操作", "action": "创建进程", "target": "cmd.exe /c net user", "description": "执行系统命令收集信息"}
        ]
        
        self.analysis_results['behaviors'] = sample_behaviors
    
    def classify_malware(self):
        """分类恶意软件"""
        # 实际实现中，这里应该：
        # 1. 基于特征和行为进行分类
        # 2. 确定恶意软件家族
        # 3. 评估威胁级别
        
        # 示例：添加模拟的分类结果
        classification = {
            "type": "Trojan",
            "family": "Emotet",
            "threat_level": "高",
            "description": "Emotet是一种多用途木马，主要用于窃取敏感信息和作为其他恶意软件的载体",
            "capabilities": ["信息窃取", "远程控制", "下载其他恶意软件"]
        }
        
        self.analysis_results['classification'] = classification
    
    def find_similar_samples(self):
        """查找相似样本"""
        # 实际实现中，这里应该：
        # 1. 基于特征查找相似样本
        # 2. 从样本库中匹配
        # 3. 计算相似度
        
        # 示例：添加模拟的相似样本
        similar_samples = [
            {"name": "emotet_sample_1.exe", "type": "Trojan", "similarity": "95%", "source": "本地样本库", "last_analyzed": "2023-10-01"},
            {"name": "emotet_sample_2.exe", "type": "Trojan", "similarity": "87%", "source": " VirusTotal", "last_analyzed": "2023-09-15"},
            {"name": "generic_trojan.exe", "type": "Trojan", "similarity": "76%", "source": "本地样本库", "last_analyzed": "2023-08-20"}
        ]
        
        self.analysis_results['similar_samples'] = similar_samples
    
    def generate_signature(self, sig_type):
        """生成恶意软件签名"""
        if sig_type == "YARA规则":
            return self.generate_yara_rule()
        elif sig_type == "哈希值":
            return self.generate_hashes()
        elif sig_type == "特征字符串":
            return self.generate_string_signatures()
        elif sig_type == "导入表特征":
            return self.generate_import_signatures()
        else:
            return "不支持的签名类型"
    
    def generate_yara_rule(self):
        """生成YARA规则"""
        rule = "rule Malware_Analysis_Generated {\n"
        rule += "    meta:\n"
        rule += "        description = \"自动生成的恶意软件签名\"\n"
        rule += "        author = \"Ghidra Malware Analyzer\"\n"
        rule += "        date = \"{}\"\n".format(datetime.now().strftime("%Y-%m-%d"))
        rule += "        family = \"{}\"\n".format(self.analysis_results.get('classification', {}).get('family', '未知'))
        rule += "\n"
        rule += "    strings:\n"
        
        # 添加特征字符串
        for sig in self.analysis_results.get('signatures', []):
            if sig['type'] == '字符串特征':
                content = sig['content'].replace('\\', '\\\\').replace('"', '\\"')
                rule += "        $" + sig['name'] + " = \"" + content + "\"\n"
        
        rule += "\n"
        rule += "    condition:\n"
        rule += "        any of them\n"
        rule += "}"
        
        return rule
    
    def generate_hashes(self):
        """生成哈希值"""
        # 实际实现中，这里应该计算文件的各种哈希值
        hashes = "# 恶意软件哈希值\n\n"
        hashes += "MD5: " + "0" * 32 + "\n"
        hashes += "SHA1: " + "0" * 40 + "\n"
        hashes += "SHA256: " + "0" * 64 + "\n"
        hashes += "SHA512: " + "0" * 128 + "\n"
        
        return hashes
    
    def generate_string_signatures(self):
        """生成特征字符串"""
        strings = "# 特征字符串\n\n"
        for sig in self.analysis_results.get('signatures', []):
            if sig['type'] == '字符串特征':
                strings += sig['name'] + ": " + sig['content'] + "\n"
        
        return strings
    
    def generate_import_signatures(self):
        """生成导入表特征"""
        imports = "# 导入表特征\n\n"
        for sig in self.analysis_results.get('signatures', []):
            if sig['type'] == '导入函数特征':
                imports += sig['name'] + ": " + sig['content'] + "\n"
        
        return imports
    
    def generate_report(self, format_type):
        """生成分析报告"""
        if format_type == "HTML":
            return self.generate_html_report()
        elif format_type == "文本":
            return self.generate_text_report()
        elif format_type == "JSON":
            return json.dumps(self.analysis_results, ensure_ascii=False, indent=2)
        else:
            return "不支持的报告格式"
    
    def generate_html_report(self):
        """生成HTML报告"""
        html = "<!DOCTYPE html>\n"
        html += "<html>\n"
        html += "<head>\n"
        html += "<title>恶意软件分析报告</title>\n"
        html += "<style>\n"
        html += "body { font-family: Arial, sans-serif; margin: 20px; }\n"
        html += "h1, h2 { color: #333; }\n"
        html += "table { border-collapse: collapse; width: 100%; margin: 20px 0; }\n"
        html += "th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n"
        html += "th { background-color: #f2f2f2; }\n"
        html += "tr:hover { background-color: #f5f5f5; }\n"
        html += ".section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }\n"
        html += ".high-risk { color: red; font-weight: bold; }\n"
        html += ".medium-risk { color: orange; font-weight: bold; }\n"
        html += ".low-risk { color: green; font-weight: bold; }\n"
        html += "</style>\n"
        html += "</head>\n"
        html += "<body>\n"
        html += "<h1>恶意软件分析报告</h1>\n"
        html += "<p>生成时间: {}</p>\n".format(datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        
        # 添加分类结果
        classification = self.analysis_results.get('classification', {})
        html += "<div class='section'>\n"
        html += "<h2>分类结果</h2>\n"
        html += "<p>类型: {}</p>\n".format(classification.get('type', '未知'))
        html += "<p>家族: {}</p>\n".format(classification.get('family', '未知'))
        html += "<p>威胁级别: <span class='high-risk'>{}</span></p>\n".format(classification.get('threat_level', '未知'))
        html += "<p>描述: {}</p>\n".format(classification.get('description', '无描述'))
        html += "<p>能力: {}</p>\n".format(', '.join(classification.get('capabilities', ['无']))) if classification.get('capabilities') else "<p>能力: 无</p>\n"
        html += "</div>\n"
        
        # 添加特征分析
        signatures = self.analysis_results.get('signatures', [])
        if signatures:
            html += "<div class='section'>\n"
            html += "<h2>特征分析</h2>\n"
            html += "<table>\n"
            html += "<tr><th>特征名称</th><th>类型</th><th>位置</th><th>匹配内容</th><th>置信度</th></tr>\n"
            for sig in signatures:
                html += "<tr>\n"
                html += "<td>{}</td>\n".format(sig['name'])
                html += "<td>{}</td>\n".format(sig['type'])
                html += "<td>{}</td>\n".format(sig['location'])
                html += "<td>{}</td>\n".format(sig['content'])
                html += "<td>{}</td>\n".format(sig['confidence'])
                html += "</tr>\n"
            html += "</table>\n"
            html += "</div>\n"
        
        # 添加行为分析
        behaviors = self.analysis_results.get('behaviors', [])
        if behaviors:
            html += "<div class='section'>\n"
            html += "<h2>行为分析</h2>\n"
            html += "<table>\n"
            html += "<tr><th>类型</th><th>操作</th><th>目标</th><th>描述</th></tr>\n"
            for behavior in behaviors:
                html += "<tr>\n"
                html += "<td>{}</td>\n".format(behavior['type'])
                html += "<td>{}</td>\n".format(behavior['action'])
                html += "<td>{}</td>\n".format(behavior['target'])
                html += "<td>{}</td>\n".format(behavior['description'])
                html += "</tr>\n"
            html += "</table>\n"
            html += "</div>\n"
        
        html += "</body>\n"
        html += "</html>"
        
        return html
    
    def generate_text_report(self):
        """生成文本报告"""
        text = "# 恶意软件分析报告\n"
        text += "=" * 80 + "\n"
        text += "生成时间: {}\n\n".format(datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        
        # 添加分类结果
        classification = self.analysis_results.get('classification', {})
        text += "## 分类结果\n"
        text += "- 类型: {}\n".format(classification.get('type', '未知'))
        text += "- 家族: {}\n".format(classification.get('family', '未知'))
        text += "- 威胁级别: {}\n".format(classification.get('threat_level', '未知'))
        text += "- 描述: {}\n".format(classification.get('description', '无描述'))
        text += "- 能力: {}\n\n".format(', '.join(classification.get('capabilities', ['无']))) if classification.get('capabilities') else "- 能力: 无\n\n"
        
        # 添加特征分析
        signatures = self.analysis_results.get('signatures', [])
        if signatures:
            text += "## 特征分析\n"
            for sig in signatures:
                text += "- {} ({}): {} at {} [{}]\n".format(sig['name'], sig['type'], sig['content'], sig['location'], sig['confidence'])
            text += "\n"
        
        # 添加行为分析
        behaviors = self.analysis_results.get('behaviors', [])
        if behaviors:
            text += "## 行为分析\n"
            for behavior in behaviors:
                text += "- {}: {} {} - {}\n".format(behavior['type'], behavior['action'], behavior['target'], behavior['description'])
            text += "\n"
        
        return text
    
    def update_signature_table(self):
        """更新特征识别结果表格"""
        # 清空表格
        self.signature_table_model.setRowCount(0)
        
        # 添加特征识别结果
        for sig in self.analysis_results.get('signatures', []):
            row = [
                sig.get('name', ''),
                sig.get('type', ''),
                sig.get('location', ''),
                sig.get('content', ''),
                sig.get('confidence', '')
            ]
            self.signature_table_model.addRow(row)
    
    def update_behavior_tree(self):
        """更新行为分析树"""
        # 实际实现中，这里应该更新行为分析树
        pass
    
    def update_classification(self):
        """更新分类结果"""
        classification = self.analysis_results.get('classification', {})
        
        text = "# 分类结果\n\n"
        text += "类型: {}\n".format(classification.get('type', '未知'))
        text += "家族: {}\n".format(classification.get('family', '未知'))
        text += "威胁级别: {}\n".format(classification.get('threat_level', '未知'))
        text += "描述: {}\n".format(classification.get('description', '无描述'))
        text += "能力: {}\n".format(', '.join(classification.get('capabilities', ['无']))) if classification.get('capabilities') else "能力: 无\n"
        
        self.classification_text.setText(text)
    
    def update_similar_table(self):
        """更新相似样本表格"""
        # 清空表格
        self.similar_table_model.setRowCount(0)
        
        # 添加相似样本
        for sample in self.analysis_results.get('similar_samples', []):
            row = [
                sample.get('name', ''),
                sample.get('type', ''),
                sample.get('similarity', ''),
                sample.get('source', ''),
                sample.get('last_analyzed', '')
            ]
            self.similar_table_model.addRow(row)
    
    def update_signature_preview(self, signature):
        """更新签名预览"""
        self.signature_preview.setText(signature)
    
    def update_report_preview(self, report):
        """更新报告预览"""
        self.report_preview.setText(report)
    
    class AnalyzeButtonListener(ActionListener):
        def __init__(self, frame):
            self.frame = frame
        
        def actionPerformed(self, e):
            # 显示进度对话框
            progress_frame = JFrame("分析中")
            progress_frame.setSize(400, 100)
            progress_frame.setLocationRelativeTo(self.frame)
            
            progress_panel = JPanel()
            progress_panel.setLayout(BorderLayout())
            
            progress_bar = JProgressBar()
            progress_bar.setIndeterminate(True)
            
            status_label = JLabel("正在执行恶意软件分析...")
            
            progress_panel.add(status_label, BorderLayout.NORTH)
            progress_panel.add(progress_bar, BorderLayout.CENTER)
            
            progress_frame.add(progress_panel)
            progress_frame.setVisible(True)
            
            # 在后台线程中执行分析
            from javax.swing import SwingWorker
            
            class AnalyzeWorker(SwingWorker):
                def __init__(self, analyzer, progress_frame):
                    self.analyzer = analyzer
                    self.progress_frame = progress_frame
                    SwingWorker.__init__(self)
                
                def doInBackground(self):
                    # 执行分析
                    self.analyzer.analyze_malware()
                    return True
                
                def done(self):
                    # 更新结果
                    self.analyzer.update_signature_table()
                    self.analyzer.update_behavior_tree()
                    self.analyzer.update_classification()
                    self.analyzer.update_similar_table()
                    
                    # 生成签名预览
                    yara_rule = self.analyzer.generate_signature("YARA规则")
                    self.analyzer.update_signature_preview(yara_rule)
                    
                    # 生成报告预览
                    report = self.analyzer.generate_report("文本")
                    self.analyzer.update_report_preview(report)
                    
                    # 关闭进度对话框
                    self.progress_frame.dispose()
                    # 显示完成消息
                    JOptionPane.showMessageDialog(self.analyzer.frame, "恶意软件分析完成！")
            
            # 启动分析线程
            worker = AnalyzeWorker(self, progress_frame)
            worker.execute()

# 主函数
if __name__ == "__main__":
    analyzer = MalwareAnalyzer()
    analyzer.run()
